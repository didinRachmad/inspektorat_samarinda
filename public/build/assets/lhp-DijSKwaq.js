import{r as h}from"./routes-De8qlvmc.js";const k={datatable:()=>h("lhp.data"),kkaStore:()=>h("kka.store"),kkaUpdate:b=>h("kka.update",b)};class g{constructor(){this.pageName="LHP",this.datatableEl=$("#datatables"),this.modalEl=$("#modalKka"),this.modal=this.modalEl.length?new bootstrap.Modal(this.modalEl[0]):null,this.form=$("#formKka"),this.listWrapper=$("#kkaList")}initIndex(){console.log(`Halaman ${this.pageName} Index berhasil dimuat!`),this.initDataTable(),this.handleApprovalButtons()}initCreate(){console.log(`Halaman ${this.pageName} Create berhasil dimuat!`),this.initForm()}initEdit(){console.log(`Halaman ${this.pageName} Edit berhasil dimuat!`),this.initForm()}initShow(){console.log(`Halaman ${this.pageName} Show berhasil dimuat!`),this.handleAddKka(),this.handleSubmitKka(),this.handleApprovalButtons()}initDataTable(){this.datatableEl.DataTable({processing:!0,serverSide:!0,ajax:k.datatable(),columns:[{data:"DT_RowIndex",name:"DT_RowIndex",className:"text-center",orderable:!1,searchable:!1,title:"No"},{data:"id",name:"id",visible:!1,title:"ID"},{data:"pkpt_no",name:"pkpt_no",title:"PKPT No"},{data:"pkpt_sasaran",name:"pkpt_sasaran",title:"PKPT Sasaran"},{data:"nomor_lhp",name:"nomor_lhp",title:"Nomor LHP"},{data:"auditi",name:"auditi",title:"Auditi"},{data:"tanggal_lhp",name:"tanggal_lhp",className:"text-center",title:"Tanggal"},{data:"rekomendasi",name:"rekomendasi",title:"Rekomendasi"},{data:"approval_status",name:"approval_status",className:"text-center",title:"Status",render:(s,r,n)=>{let a="secondary",l="-";switch(s){case"draft":a="secondary",l="Draft";break;case"waiting":a="warning",l="Menunggu Approval";break;case"approved":a="success",l="Disetujui";break;case"rejected":a="danger",l="Ditolak";break}return`<span class="badge bg-${a}">${l}</span>`}},{data:"next_approver",name:"next_approver",title:"Approval"},{data:"approval_note",name:"approval_note",title:"Notes Approval",render:(s,r,n)=>s||"-"},{data:null,orderable:!1,searchable:!1,className:"text-center no-export",title:"Aksi",render:(s,r,n)=>{let a="";return n.can_show&&(a+=`
                <a href="${n.show_url}" class="btn btn-sm btn-info rounded-4" data-bs-toggle="tooltip" title="Detail">
                    <i class="bi bi-eye-fill"></i>
                </a>`),n.can_edit&&(a+=`
                <a href="${n.edit_url}" class="btn btn-sm btn-warning rounded-4" data-bs-toggle="tooltip" title="Edit">
                    <i class="bi bi-pencil-square"></i>
                </a>`),(n.can_approve||n.is_super_admin)&&(n.approval_status==="draft"?a+=`
                    <button type="button" class="btn btn-sm btn-success rounded-4 btn-approve"
                        data-url="${n.approve_url}" data-action="approve" data-bs-toggle="tooltip"
                        title="Kirim untuk Approval"><i class="bi bi-send"></i></button>`:a+=`
                    <button type="button" class="btn btn-sm btn-success rounded-4 btn-approve"
                        data-url="${n.approve_url}" data-action="approve" data-bs-toggle="tooltip" title="Setujui"><i class="bi bi-check-circle"></i></button>
                    <button type="button" class="btn btn-sm btn-secondary rounded-4 btn-revise"
                        data-url="${n.approve_url}" data-action="revise" data-bs-toggle="tooltip" title="Revisi"><i class="bi bi-arrow-return-left"></i></button>
                    <button type="button" class="btn btn-sm btn-danger rounded-4 btn-reject"
                        data-url="${n.approve_url}" data-action="reject" data-bs-toggle="tooltip" title="Tolak"><i class="bi bi-x-circle"></i></button>`),n.can_delete&&n.approval_status==="draft"&&(a+=`
                <form action="${n.delete_url}" method="POST" class="d-inline form-delete">
                    <input type="hidden" name="_token" value="${$('meta[name="csrf-token"]').attr("content")}">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="button" class="btn btn-sm btn-danger rounded-4 btn-delete" data-bs-toggle="tooltip" title="Hapus">
                        <i class="bi bi-trash-fill"></i>
                    </button>
                </form>`),`<div class="d-flex justify-content-center gap-1">${a}</div>`}}],dom:"<'row'<'col-md-3'l><'col-md-6 text-center'><'col-md-3'f>><'row table-responsive py-2'<'col-sm-12'tr>><'row'<'col-md-5'i><'col-md-7'p>>",paging:!0,responsive:!0,pageLength:20,lengthMenu:[[20,50,-1],[20,50,"Semua"]],order:[[1,"desc"]],info:!0,language:{sEmptyTable:"Tidak ada data yang tersedia di tabel",sInfo:"Menampilkan _START_ hingga _END_ dari _TOTAL_ entri",sInfoFiltered:"(disaring dari _MAX_ entri keseluruhan)",sLengthMenu:"Tampilkan _MENU_ entri",sLoadingRecords:"Memuat...",sProcessing:"Sedang memproses...",sSearch:"Cari:",sZeroRecords:"Tidak ditemukan data yang cocok",oAria:{sSortAscending:": aktifkan untuk mengurutkan kolom menaik",sSortDescending:": aktifkan untuk mengurutkan kolom menurun"}},drawCallback:()=>$('[data-bs-toggle="tooltip"]').each(function(){new bootstrap.Tooltip(this)})})}handleApprovalButtons(){$(document).on("click",".btn-approve, .btn-reject, .btn-revise",s=>{const r=$(s.currentTarget),n=r.data("url"),a=r.data("action"),l=r.data("redirect"),m=a==="approve"?"Setujui":a==="reject"?"Tolak":"Revisi";showInputDialog(`${m} LHP`,"Tambahkan catatan (opsional):",p=>{fetch(n,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},body:JSON.stringify({_method:"PATCH",action:a,note:p})}).then(d=>d.json()).then(d=>{d.status?(showToast(d.message,"success"),l?window.location.href=l:this.datatableEl.DataTable().ajax.reload(null,!1)):showAlert("Gagal",d.message||"Terjadi kesalahan","error")}).catch(d=>{console.error(d),showAlert("Error","Terjadi kesalahan pada server","error")})})})}initForm(){const s=(t,e=null)=>{if(!t)return;const o=$(`#pkptSelect option[value="${t}"]`).data("auditis")||[],c=$("#auditiSelect");c.empty().append('<option value="">-- pilih auditi --</option>'),o.forEach(u=>{const f=u.id==e?"selected":"";c.append(`<option value="${u.id}" ${f}>${u.nama_auditi}</option>`)}),c.trigger("change")},r=$("#pkptSelect").data("selected"),n=$("#pkptSelect").data("selected-auditi");r&&s(r,n),$("#pkptSelect").on("change",function(){const t=$(this).val();s(t)});let a=$("#temuanContainer .temuan-item").length;function l(){let t=$("#temuanTemplate").html().replaceAll("[i]",a).replaceAll("[index]",a+1),e=$(t);$("#temuanContainer").append(e),reinitPlugins(e),m(e),e.data("fileCounter",0),a++}$("#temuanContainer .temuan-item").length===0&&l(),$("#btnAddTemuan").on("click",()=>l()),$(document).on("click",".remove-temuan",function(){const t=$(this).closest(".temuan-item");if($("#temuanContainer .temuan-item").length<=1){showAlert("Tidak bisa dihapus!","Minimal harus ada satu temuan.","warning");return}const i=t.find("h6").text();showConfirmDialog(`Hapus ${i}?`,"Data temuan ini akan dihapus.",()=>{t.remove(),p(),showAlert("Berhasil!","Temuan berhasil dihapus.","success")},"delete")}),$(document).on("click",".btnAddFile",function(){const t=$(this).closest(".temuan-item"),e=t.find(".filePendukung tbody");let i=t.data("fileCounter")||e.find("tr").length,o=t.index(),c=$("#fileTemplate").html().replaceAll("[i]",o).replaceAll("[j]",i);e.append(c),i++,t.data("fileCounter",i)}),$(document).on("click",".remove-file",function(){const t=$(this).closest("tr"),e=$(this).closest("tbody");if(e.find("tr").length<=1){showAlert("Tidak bisa dihapus!","Minimal satu file harus ada.","warning");return}const o=t.find("input[type='hidden']").val();o&&e.append(`<input type="hidden" name="deleted_files[]" value="${o}">`),t.remove()}),$(document).on("click",".btnAddRekomendasi",function(){const t=$(this).closest(".temuan-item"),e=t.index(),i=t.find(".rekomendasiTable tbody"),o=i.find("tr").length;let c=$("#rekomendasiTemplate").html().replaceAll("[i]",e).replaceAll("[j]",o);i.append(c),reinitPlugins(i.find("tr").last()),m(t)}),$(document).on("click",".remove-rekomendasi",function(){if($(this).closest("tbody").find("tr").length<=1){showAlert("Tidak bisa dihapus!","Minimal satu rekomendasi harus ada.","warning");return}$(this).closest("tr").remove(),d($(this).closest(".temuan-item"))});function m(t){const e=t.find(".kode-temuan-select").val(),i=t.find(".kode-temuan-select").data("rekom");t.find(".rekomendasiTable tbody tr").each(function(){const o=$(this).find("select"),c=o.val();o.empty().append('<option value="">-- Pilih Kode Rekomendasi --</option>'),e&&i[e]&&i[e].forEach(u=>{o.append(`<option value="${u.id}" ${u.id==c?"selected":""}>${u.kode} | ${u.nama_rekomendasi}</option>`)})})}$("#temuanContainer .temuan-item").each(function(){m($(this))}),$(document).on("change",".kode-temuan-select",function(){const t=$(this).closest(".temuan-item");m(t)});function p(){$("#temuanContainer .temuan-item").each(function(t){$(this).find("h6").text(`Temuan #${t+1}`),$(this).find("[name]").not('input[type="file"]').each(function(){let e=$(this).attr("name");e=e.replace(/\[temuans]\[\d+]/,`[temuans][${t}]`),$(this).attr("name",e)}),d($(this))}),a=$("#temuanContainer .temuan-item").length}function d(t){const e=t.index();t.find(".rekomendasiTable tbody tr").each(function(i){$(this).find("[name]").each(function(){let o=$(this).attr("name");o=o.replace(/\[temuans]\[\d+]/,`[temuans][${e}]`).replace(/\[rekomendasis]\[\d+]/,`[rekomendasis][${i}]`),$(this).attr("name",o)})})}}handleAddKka(){let s=document.getElementById("btnAddKka");s&&s.addEventListener("click",()=>{this.form.trigger("reset"),this.modalEl.find(".modal-title").text("Tambah KKA"),this.modal.show()})}handleSubmitKka(){this.form.length&&$("#btnSaveKka").on("click",()=>{this.form.submit()})}}const T=new g;export{T as default};
